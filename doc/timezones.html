<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>untitled</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Ryan Bigg">
	<!-- Date: 2009-06-08 -->
	<link rel='stylesheet' href='style.css'>
	<link rel='stylesheet' href='sunburst.css'>
</head>
<body>
  <div id='header'>
    <img src='images/how_rails_works.jpg'>
  </div>
  <div id='content'>
    <h1>How Rails Works: Timezones</h1>
<h2>Introduction</h2>
<p>This is the first post in the How Rails Works series and covers how timezones work in a Rails 2.3 application. This guide was written by Ryan Bigg.</p>
<h2>Configuration</h2>
<p>Timezones depends on the configuration of your applicationm which is set up when you application initializes courtesy of <em>railties/lib/initializer.rb</em> and the <ins>Configuration</ins> class. This class is defined on <a href="http://github.com/rails/rails/blob/2-3-stable/railties/lib/initializer.rb#L649">line #649 of <em>initializer.rb</em></a> like this:</p>
<pre class="sunburst"><span class="line-numbers">   1 </span> <span class="Keyword">class</span> <span class="JEntityNameType">Configuration</span>
</pre>
<p>When you open up the <ins>Rails::Initializer.run</ins> block in your <em>config/environment.rb</em> the object you&#8217;re given in the block is a <ins>Configuration</ins> instance. What&#8217;s more important in <em>initializer.rb</em> is that inside this <ins>class Configuration</ins> declaration it defines an <ins>attr_accessor</ins> for <ins>time_zone</ins> on <a href="http://github.com/rails/rails/blob/2-3-stable/railties/lib/initializer.rb#L824-827">line #827</a>:</p>
<pre class="sunburst"><span class="line-numbers">   1 </span> <span class="Comment"><span class="Comment">#</span> Sets the default time_zone. Setting this will enable time_zone</span>
<span class="line-numbers">   2 </span> <span class="Comment"><span class="Comment">#</span> awareness for Active Record models and set the Active Record default</span>
<span class="line-numbers">   3 </span> <span class="Comment"><span class="Comment">#</span> timezone to :utc</span>
<span class="line-numbers">   4 </span> <span class="Keyword">attr_accessor</span> <span class="Constant"><span class="Constant">:</span>time_zone</span>
</pre>
<p>Pay close attention to this comment for this as it explains if you <strong>do not</strong> set this value your Active Record models will <strong>not be timezone aware</strong>. You&#8217;ve been warned. What this <ins>attr_accessor</ins> does is set up a setter and a getter for an attribute on the <ins>Configuration</ins> instance. When Rails initializes it reads this method using the <ins>initialize_time_zone</ins> called on <a href="http://github.com/rails/rails/blob/2-3-stable/railties/lib/initializer.rb#L152">line #152 of initializer.rb</a> and defined on <a href="http://github.com/rails/rails/blob/2-3-stable/railties/lib/initializer.rb#L553-570">lines #553-570</a> as:</p>
<pre class="sunburst"><span class="line-numbers">   1 </span> <span class="Keyword">def</span> <span class="Entity">initialize_time_zone</span>
<span class="line-numbers">   2 </span>   <span class="Keyword">if</span> configuration.<span class="Entity">time_zone</span>
<span class="line-numbers">   3 </span>     zone_default <span class="Keyword">=</span> <span class="Variable">Time</span>.__<span class="Entity">send__</span>(<span class="Constant"><span class="Constant">:</span>get_zone</span>, configuration.<span class="Entity">time_zone</span>)
<span class="line-numbers">   4 </span> 
<span class="line-numbers">   5 </span>     <span class="Keyword">unless</span> zone_default
<span class="line-numbers">   6 </span>       <span class="Keyword">raise</span> \
<span class="line-numbers">   7 </span>         <span class="String"><span class="String">'</span>Value assigned to config.time_zone not recognized.<span class="String">'</span></span> <span class="Keyword">+</span>
<span class="line-numbers">   8 </span>         <span class="String"><span class="String">'</span>Run &quot;rake -D time&quot; for a list of tasks for finding appropriate time zone names.<span class="String">'</span></span>
<span class="line-numbers">   9 </span>     <span class="Keyword">end</span>
<span class="line-numbers">  10 </span> 
<span class="line-numbers">  11 </span>     <span class="Support">Time</span>.<span class="Entity">zone_default</span> <span class="Keyword">=</span> zone_default
<span class="line-numbers">  12 </span> 
<span class="line-numbers">  13 </span>     <span class="Keyword">if</span> configuration.<span class="Entity">frameworks</span>.<span class="Entity">include?</span>(<span class="Constant"><span class="Constant">:</span>active_record</span>)
<span class="line-numbers">  14 </span>       <span class="Support">ActiveRecord</span>::<span class="Entity">Base</span>.<span class="Entity">time_zone_aware_attributes</span> <span class="Keyword">=</span> <span class="Constant">true</span>
<span class="line-numbers">  15 </span>       <span class="Support">ActiveRecord</span>::<span class="Entity">Base</span>.<span class="Entity">default_timezone</span> <span class="Keyword">=</span> <span class="Constant"><span class="Constant">:</span>utc</span>
<span class="line-numbers">  16 </span>     <span class="Keyword">end</span>
<span class="line-numbers">  17 </span>   <span class="Keyword">end</span>
<span class="line-numbers">  18 </span> <span class="Keyword">end</span>
</pre>
<h2><ins>get_zone</ins></h2>
<p>This checks to see if the <ins>time_zone</ins> attribute on the <ins>configuration</ins> object is set and if it is will go through the process of setting up the default timezone. This makes a call to the private method <ins>get_zone</ins> on <ins>Time</ins> using <ins><i>send</i></ins> because calling <ins>send</ins> will no longer work on Ruby 1.9 for private methods. <ins>get_zone</ins> is defined on <a href="http://github.com/rails/rails/blob/4b68debb1c4d3d272b237049c88d01b1eceb58f0/activesupport/lib/active_support/core_ext/time/zones.rb#L55-65">lines #55-65 of activesupport/lib/active_support/core_ext/time/zones.rb</a>:</p>
<pre class="sunburst"><span class="line-numbers">   1 </span> <span class="Keyword">def</span> <span class="Entity">get_zone</span>(<span class="Variable">time_zone</span>)
<span class="line-numbers">   2 </span>   <span class="Keyword">return</span> time_zone <span class="Keyword">if</span> time_zone.<span class="Entity">nil?</span> <span class="Keyword">||</span> time_zone.<span class="Entity">is_a?</span>(<span class="Variable">TimeZone</span>)
<span class="line-numbers">   3 </span> <span class="Comment">  <span class="Comment">#</span> lookup timezone based on identifier (unless we've been passed a TZInfo::Timezone)</span>
<span class="line-numbers">   4 </span>   <span class="Keyword">unless</span> time_zone.<span class="Entity">respond_to?</span>(<span class="Constant"><span class="Constant">:</span>period_for_local</span>)
<span class="line-numbers">   5 </span>     time_zone <span class="Keyword">=</span> <span class="Support">TimeZone</span>[time_zone] <span class="Keyword">||</span> <span class="Variable">TZInfo</span>::<span class="Entity">Timezone</span>.<span class="Entity">get</span>(time_zone) <span class="Keyword">rescue</span> <span class="Constant">nil</span>
<span class="line-numbers">   6 </span>   <span class="Keyword">end</span>
<span class="line-numbers">   7 </span> <span class="Comment">  <span class="Comment">#</span> Return if a TimeZone instance, or wrap in a TimeZone instance if a TZInfo::Timezone</span>
<span class="line-numbers">   8 </span>   <span class="Keyword">if</span> time_zone
<span class="line-numbers">   9 </span>     time_zone.<span class="Entity">is_a?</span>(<span class="Variable">TimeZone</span>) <span class="Keyword">?</span> time_zone : <span class="Support">TimeZone</span>.<span class="Entity">create</span>(time_zone.<span class="Entity">name</span>, <span class="Constant">nil</span>, time_zone)
<span class="line-numbers">  10 </span>   <span class="Keyword">end</span>
<span class="line-numbers">  11 </span> <span class="Keyword">end</span>
</pre>
<p>If the argument <ins>time_zone</ins> we&#8217;ve passed is <ins>nil</ins> or a <ins>TimeZone</ins> object this method will return the <ins>time_zone</ins> object. If it is not, it will check to see if it <ins>respond_to?</ins> <ins>period_for_local</ins> and if it does not then it will call <ins>TimeZone[time_zone]</ins> and if that returns nil then <ins>TZInfo::Timezone.get(time_zone)</ins> is called and then if that fails, it will set <ins>time_zone</ins> to be nil by the <ins>rescue nil</ins> at the end.</p>
<p>If <ins>time_zone</ins> is set by this chain of events, then it will continue on and check if the object <ins>is_a?(TimeZone)</ins> and just return the object if it is. If it is not, then it will call the <ins>create</ins> method on the <ins>TimeZone</ins> class.</p>
<h2><ins>TimeZone#[]</ins></h2>
<p>We&#8217;ll cover the <ins>[]</ins> method on TimeZone first. This method can be found on <a href="http://github.com/rails/rails/blob/4b68debb1c4d3d272b237049c88d01b1eceb58f0/activesupport/lib/active_support/values/time_zone.rb#L385-395">lines #385-395 of activesupport/lib/active_support/values/time_zone.rb</a>:</p>
<pre class="sunburst"><span class="line-numbers">   1 </span> <span class="Keyword">def</span> <span class="Entity">[]</span>(<span class="Variable">arg</span>)
<span class="line-numbers">   2 </span>   <span class="Keyword">case</span> arg
<span class="line-numbers">   3 </span>     <span class="Keyword">when</span> <span class="Variable">String</span>
<span class="line-numbers">   4 </span>       <span class="Variable">ZONES_MAP</span>[arg]
<span class="line-numbers">   5 </span>     <span class="Keyword">when</span> <span class="Variable">Numeric</span>, <span class="Support">ActiveSupport</span>::<span class="Entity">Duration</span>
<span class="line-numbers">   6 </span>       arg <span class="Keyword">*=</span> <span class="Constant">3600</span> <span class="Keyword">if</span> arg.<span class="Entity">abs</span> <span class="Keyword">&amp;</span>lt;<span class="Keyword">=</span> <span class="Constant">13</span>
<span class="line-numbers">   7 </span>       all.<span class="Entity">find</span> { |<span class="Variable">z</span>| z.<span class="Entity">utc_offset</span> <span class="Keyword">==</span> arg.<span class="Entity">to_i</span> }
<span class="line-numbers">   8 </span>     <span class="Keyword">else</span>
<span class="line-numbers">   9 </span>       <span class="Keyword">raise</span> <span class="Variable">ArgumentError</span>, <span class="String"><span class="String">&quot;</span>invalid argument to TimeZone[]: <span class="StringEmbeddedSource"><span class="StringEmbeddedSource">#{</span>arg<span class="StringEmbeddedSource"><span class="StringEmbeddedSource">.</span><span class="Entity">inspect</span></span><span class="StringEmbeddedSource">}</span></span><span class="String">&quot;</span></span>
<span class="line-numbers">  10 </span>   <span class="Keyword">end</span>
<span class="line-numbers">  11 </span> <span class="Keyword">end</span>
</pre>
<p>If this method is passed a <ins>String</ins> it will look up the relevant key in <ins>ZONE_MAPS</ins> which is defined on <a href="http://github.com/rails/rails/blob/4b68debb1c4d3d272b237049c88d01b1eceb58f0/activesupport/lib/active_support/values/time_zone.rb#L297-357">lines #297-357 of activesupport/lib/active_support/values/time_zone.rb</a>:</p>
<pre class="sunburst"><span class="line-numbers">   1 </span> <span class="Variable">ZONES</span> <span class="Keyword">=</span> []
<span class="line-numbers">   2 </span> <span class="Variable">ZONES_MAP</span> <span class="Keyword">=</span> {}
<span class="line-numbers">   3 </span> [[<span class="Keyword">-</span><span class="Constant">39_600</span>, <span class="String"><span class="String">&quot;</span>International Date Line West<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Midway Island<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Samoa<span class="String">&quot;</span></span> ],
<span class="line-numbers">   4 </span>  [<span class="Keyword">-</span><span class="Constant">36_000</span>, <span class="String"><span class="String">&quot;</span>Hawaii<span class="String">&quot;</span></span> ],
<span class="line-numbers">   5 </span>  [<span class="Keyword">-</span><span class="Constant">32_400</span>, <span class="String"><span class="String">&quot;</span>Alaska<span class="String">&quot;</span></span> ],
<span class="line-numbers">   6 </span>  [<span class="Keyword">-</span><span class="Constant">28_800</span>, <span class="String"><span class="String">&quot;</span>Pacific Time (US &amp;amp; Canada)<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Tijuana<span class="String">&quot;</span></span> ],
<span class="line-numbers">   7 </span>  [<span class="Keyword">-</span><span class="Constant">25_200</span>, <span class="String"><span class="String">&quot;</span>Mountain Time (US &amp;amp; Canada)<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Chihuahua<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Mazatlan<span class="String">&quot;</span></span>,
<span class="line-numbers">   8 </span>            <span class="String"><span class="String">&quot;</span>Arizona<span class="String">&quot;</span></span> ],
<span class="line-numbers">   9 </span>  [<span class="Keyword">-</span><span class="Constant">21_600</span>, <span class="String"><span class="String">&quot;</span>Central Time (US &amp;amp; Canada)<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Saskatchewan<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Guadalajara<span class="String">&quot;</span></span>,
<span class="line-numbers">  10 </span>            <span class="String"><span class="String">&quot;</span>Mexico City<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Monterrey<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Central America<span class="String">&quot;</span></span> ],
<span class="line-numbers">  11 </span>  [<span class="Keyword">-</span><span class="Constant">18_000</span>, <span class="String"><span class="String">&quot;</span>Eastern Time (US &amp;amp; Canada)<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Indiana (East)<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Bogota<span class="String">&quot;</span></span>,
<span class="line-numbers">  12 </span>            <span class="String"><span class="String">&quot;</span>Lima<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Quito<span class="String">&quot;</span></span> ],
<span class="line-numbers">  13 </span>  [<span class="Keyword">-</span><span class="Constant">16_200</span>, <span class="String"><span class="String">&quot;</span>Caracas<span class="String">&quot;</span></span> ],
<span class="line-numbers">  14 </span>  [<span class="Keyword">-</span><span class="Constant">14_400</span>, <span class="String"><span class="String">&quot;</span>Atlantic Time (Canada)<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>La Paz<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Santiago<span class="String">&quot;</span></span> ],
<span class="line-numbers">  15 </span>  [<span class="Keyword">-</span><span class="Constant">12_600</span>, <span class="String"><span class="String">&quot;</span>Newfoundland<span class="String">&quot;</span></span> ],
<span class="line-numbers">  16 </span>  [<span class="Keyword">-</span><span class="Constant">10_800</span>, <span class="String"><span class="String">&quot;</span>Brasilia<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Buenos Aires<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Georgetown<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Greenland<span class="String">&quot;</span></span> ],
<span class="line-numbers">  17 </span>  [ <span class="Keyword">-</span><span class="Constant">7_200</span>, <span class="String"><span class="String">&quot;</span>Mid-Atlantic<span class="String">&quot;</span></span> ],
<span class="line-numbers">  18 </span>  [ <span class="Keyword">-</span><span class="Constant">3_600</span>, <span class="String"><span class="String">&quot;</span>Azores<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Cape Verde Is.<span class="String">&quot;</span></span> ],
<span class="line-numbers">  19 </span>  [      <span class="Constant">0</span>, <span class="String"><span class="String">&quot;</span>Dublin<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Edinburgh<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Lisbon<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>London<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Casablanca<span class="String">&quot;</span></span>,
<span class="line-numbers">  20 </span>            <span class="String"><span class="String">&quot;</span>Monrovia<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>UTC<span class="String">&quot;</span></span> ],
<span class="line-numbers">  21 </span>  [  <span class="Constant">3_600</span>, <span class="String"><span class="String">&quot;</span>Belgrade<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Bratislava<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Budapest<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Ljubljana<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Prague<span class="String">&quot;</span></span>,
<span class="line-numbers">  22 </span>            <span class="String"><span class="String">&quot;</span>Sarajevo<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Skopje<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Warsaw<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Zagreb<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Brussels<span class="String">&quot;</span></span>,
<span class="line-numbers">  23 </span>            <span class="String"><span class="String">&quot;</span>Copenhagen<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Madrid<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Paris<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Amsterdam<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Berlin<span class="String">&quot;</span></span>,
<span class="line-numbers">  24 </span>            <span class="String"><span class="String">&quot;</span>Bern<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Rome<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Stockholm<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Vienna<span class="String">&quot;</span></span>,
<span class="line-numbers">  25 </span>            <span class="String"><span class="String">&quot;</span>West Central Africa<span class="String">&quot;</span></span> ],
<span class="line-numbers">  26 </span>  [  <span class="Constant">7_200</span>, <span class="String"><span class="String">&quot;</span>Bucharest<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Cairo<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Helsinki<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Kyev<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Riga<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Sofia<span class="String">&quot;</span></span>,
<span class="line-numbers">  27 </span>            <span class="String"><span class="String">&quot;</span>Tallinn<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Vilnius<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Athens<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Istanbul<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Minsk<span class="String">&quot;</span></span>,
<span class="line-numbers">  28 </span>            <span class="String"><span class="String">&quot;</span>Jerusalem<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Harare<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Pretoria<span class="String">&quot;</span></span> ],
<span class="line-numbers">  29 </span>  [ <span class="Constant">10_800</span>, <span class="String"><span class="String">&quot;</span>Moscow<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>St. Petersburg<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Volgograd<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Kuwait<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Riyadh<span class="String">&quot;</span></span>,
<span class="line-numbers">  30 </span>            <span class="String"><span class="String">&quot;</span>Nairobi<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Baghdad<span class="String">&quot;</span></span> ],
<span class="line-numbers">  31 </span>  [ <span class="Constant">12_600</span>, <span class="String"><span class="String">&quot;</span>Tehran<span class="String">&quot;</span></span> ],
<span class="line-numbers">  32 </span>  [ <span class="Constant">14_400</span>, <span class="String"><span class="String">&quot;</span>Abu Dhabi<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Muscat<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Baku<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Tbilisi<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Yerevan<span class="String">&quot;</span></span> ],
<span class="line-numbers">  33 </span>  [ <span class="Constant">16_200</span>, <span class="String"><span class="String">&quot;</span>Kabul<span class="String">&quot;</span></span> ],
<span class="line-numbers">  34 </span>  [ <span class="Constant">18_000</span>, <span class="String"><span class="String">&quot;</span>Ekaterinburg<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Islamabad<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Karachi<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Tashkent<span class="String">&quot;</span></span> ],
<span class="line-numbers">  35 </span>  [ <span class="Constant">19_800</span>, <span class="String"><span class="String">&quot;</span>Chennai<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Kolkata<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Mumbai<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>New Delhi<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Sri Jayawardenepura<span class="String">&quot;</span></span> ],
<span class="line-numbers">  36 </span>  [ <span class="Constant">20_700</span>, <span class="String"><span class="String">&quot;</span>Kathmandu<span class="String">&quot;</span></span> ],
<span class="line-numbers">  37 </span>  [ <span class="Constant">21_600</span>, <span class="String"><span class="String">&quot;</span>Astana<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Dhaka<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Almaty<span class="String">&quot;</span></span>,
<span class="line-numbers">  38 </span>            <span class="String"><span class="String">&quot;</span>Novosibirsk<span class="String">&quot;</span></span> ],
<span class="line-numbers">  39 </span>  [ <span class="Constant">23_400</span>, <span class="String"><span class="String">&quot;</span>Rangoon<span class="String">&quot;</span></span> ],
<span class="line-numbers">  40 </span>  [ <span class="Constant">25_200</span>, <span class="String"><span class="String">&quot;</span>Bangkok<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Hanoi<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Jakarta<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Krasnoyarsk<span class="String">&quot;</span></span> ],
<span class="line-numbers">  41 </span>  [ <span class="Constant">28_800</span>, <span class="String"><span class="String">&quot;</span>Beijing<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Chongqing<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Hong Kong<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Urumqi<span class="String">&quot;</span></span>,
<span class="line-numbers">  42 </span>            <span class="String"><span class="String">&quot;</span>Kuala Lumpur<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Singapore<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Taipei<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Perth<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Irkutsk<span class="String">&quot;</span></span>,
<span class="line-numbers">  43 </span>            <span class="String"><span class="String">&quot;</span>Ulaan Bataar<span class="String">&quot;</span></span> ],
<span class="line-numbers">  44 </span>  [ <span class="Constant">32_400</span>, <span class="String"><span class="String">&quot;</span>Seoul<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Osaka<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Sapporo<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Tokyo<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Yakutsk<span class="String">&quot;</span></span> ],
<span class="line-numbers">  45 </span>  [ <span class="Constant">34_200</span>, <span class="String"><span class="String">&quot;</span>Darwin<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Adelaide<span class="String">&quot;</span></span> ],
<span class="line-numbers">  46 </span>  [ <span class="Constant">36_000</span>, <span class="String"><span class="String">&quot;</span>Canberra<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Melbourne<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Sydney<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Brisbane<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Hobart<span class="String">&quot;</span></span>,
<span class="line-numbers">  47 </span>            <span class="String"><span class="String">&quot;</span>Vladivostok<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Guam<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Port Moresby<span class="String">&quot;</span></span> ],
<span class="line-numbers">  48 </span>  [ <span class="Constant">39_600</span>, <span class="String"><span class="String">&quot;</span>Magadan<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Solomon Is.<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>New Caledonia<span class="String">&quot;</span></span> ],
<span class="line-numbers">  49 </span>  [ <span class="Constant">43_200</span>, <span class="String"><span class="String">&quot;</span>Fiji<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Kamchatka<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Marshall Is.<span class="String">&quot;</span></span>, <span class="String"><span class="String">&quot;</span>Auckland<span class="String">&quot;</span></span>,
<span class="line-numbers">  50 </span>            <span class="String"><span class="String">&quot;</span>Wellington<span class="String">&quot;</span></span> ],
<span class="line-numbers">  51 </span>  [ <span class="Constant">46_800</span>, <span class="String"><span class="String">&quot;</span>Nuku'alofa<span class="String">&quot;</span></span> ]].
<span class="line-numbers">  52 </span> each <span class="Keyword">do </span>|<span class="Variable">offset</span>, *<span class="Variable">places</span>|
<span class="line-numbers">  53 </span>   places.<span class="Entity">each</span> <span class="Keyword">do </span>|<span class="Variable">place</span>|
<span class="line-numbers">  54 </span>     place.<span class="Entity">freeze</span>
<span class="line-numbers">  55 </span>     zone <span class="Keyword">=</span> <span class="Keyword">new</span>(place, offset)
<span class="line-numbers">  56 </span>     <span class="Variable">ZONES</span> <span class="Keyword">&amp;</span>lt;<span class="Keyword">&amp;</span>lt; zone
<span class="line-numbers">  57 </span>     <span class="Variable">ZONES_MAP</span>[place] <span class="Keyword">=</span> zone
<span class="line-numbers">  58 </span>   <span class="Keyword">end</span>
<span class="line-numbers">  59 </span> <span class="Keyword">end</span>
<span class="line-numbers">  60 </span> <span class="Variable">ZONES</span>.<span class="Entity">sort!</span>
<span class="line-numbers">  61 </span> <span class="Variable">ZONES</span>.<span class="Entity">freeze</span>
<span class="line-numbers">  62 </span> <span class="Variable">ZONES_MAP</span>.freeze
</pre>
<p>This defines the <ins>ZONE_MAPS</ins> hash with the key being the name of the place and the value being the number of seconds the timezone is offset from <span class="caps">UTC</span>. It accomplishes this by going through the array defined with the offset and the related places and calls the <ins>new</ins> method passing in the <ins>place</ins> and <ins>offset</ins> variables to it. The <ins>new</ins> method is one given to you by Ruby and will create a new <ins>TimeZone</ins> object and then call the <ins>initialize</ins> method on it. This <ins>initialize</ins> method is defined on <a href="http://github.com/rails/rails/blob/4b68debb1c4d3d272b237049c88d01b1eceb58f0/activesupport/lib/active_support/values/time_zone.rb#L180-184">lines #180-#184 of activesupport/lib/active_support/values/time_zone.rb</a>:</p>
<pre class="sunburst"><span class="line-numbers">   1 </span> <span class="Keyword">def</span> <span class="Entity">initialize</span>(<span class="Variable">name<span class="Variable">,</span> utc_offset<span class="Variable">,</span> tzinfo <span class="Keyword">=</span> <span class="Constant">nil</span></span>)
<span class="line-numbers">   2 </span>     <span class="Variable"><span class="Variable">@</span>name</span> <span class="Keyword">=</span> name
<span class="line-numbers">   3 </span>     <span class="Variable"><span class="Variable">@</span>utc_offset</span> <span class="Keyword">=</span> utc_offset
<span class="line-numbers">   4 </span>     <span class="Variable"><span class="Variable">@</span>tzinfo</span> <span class="Keyword">=</span> tzinfo
<span class="line-numbers">   5 </span>   <span class="Keyword">end</span>
</pre>
  </div>
</body>
</html>
